parameters:
  - name: location_list
    optional: true
  - name: location_name
action_groups:
  - actions:
      - type: set-variables
        scripting_type: handlebars
        variables:
          - name: locations_formatted
            value: >
              {{#each location_list}}
                {{#with this}}
                  {{#if preferredName}}
                    {
                      "locationName": "{{preferredName.name}}",
                      "locationNameId": "{{#if preferredName.id}}{{uppercase (remove preferredName.id '-')}}{{/if}}",
                      "locationSubDivision": "{{#if parent}}{{#unless (eq parent.preferredName.type 'COUNTRY')}}{{parent.preferredName.name}}{{/unless}}{{/if}}",
                      "locationCountry": "{{#if parent}}{{#if (eq parent.preferredName.type 'COUNTRY')}}{{parent.preferredName.name}}{{else}}{{#if parent.parent}}{{parent.parent.preferredName.name}}{{/if}}{{/if}}{{/if}}"
                    }{{#unless @last}},{{/unless}}
                  {{/if}}
                {{/with}}
              {{/each}}
      - type: set-variables
        scripting_type: handlebars
        variables:
          - name: locations_json
            value: >
              {{json locations_formatted}}
      - type: message
        message:
          type: ui5integrationCard
          content: >
            {
              "sap.app": {
                  "id": "com.sap.concur.request.assistant.location",
                  "type": "card",
                  "title": "SAP Concur Locations Card"
              },
              "sap.card": {
                  "type": "List",
                  "header": {
                      "title": "Concur Locations",
                      "subTitle": "I could not identify <? location_name ?>, please select the location from the list",
                      "icon": {
                          "src": "sap-icon://locate-me"
                      }
                  },
                  "content": {
                      "data": {
                          "json": [<? locations_json ?>]
                      },
                      "item": {
                          "title": "{locationName}",
                          "description": "{locationSubDivision} {locationCountry}",
                          "actions": [
                              {
                                  "type": "Submit",
                                  "data": {
                                      "locationNameId": "{locationNameId}",
                                      "locationName": "{locationName}",
                                      "locationSubDivision": "{locationSubDivision}", 
                                      "locationCountry": "{locationCountry}"
                                  }
                              }
                          ]
                      },
                      "maxItems": <? location_list.size() ?>
                  },
                  "footer": {
                      "paginator": {
                           "pageSize": 5
                       }
                  }
              }
            }
result:
  location_name_id: <? submitted_location.locationNameId  ?>