parameters:
  - name: action
    optional: true  # get, set, update
  - name: first_name
    optional: true
  - name: last_name
    optional: true
  - name: preferred_name
    optional: true
  - name: chat_id
    optional: true

action_groups:
  # Initialize variables
  - actions:
      - type: set-variables
        variables:
          - name: operation_status
            value: "initializing"
          - name: name_data
            value: null
          - name: result_message
            value: ""
          - name: graphql_query
            value: "{ JouleCompleteUserProfile { name { firstName lastName middleName preferredName honorificPrefix honorificSuffix } } }"
          - name: jwt_token
            value: "<? new i18n('JWT').toString() ?>"
          - name: action_type
            value: "<? action != null ? action.toLowerCase() : null ?>"
          - name: is_update_action
            value: "<? action_type == 'set' || action_type == 'update' || action_type == 'set/update' ?>"
          - name: has_update_fields
            value: "<? (first_name != null && !first_name.isEmpty()) || (last_name != null && !last_name.isEmpty()) || (preferred_name != null && !preferred_name.isEmpty()) ?>"
          - name: update_result
            value: null
          - name: update_status
            value: 0
          
  # First, retrieve current profile names
  - actions:
      - type: set-variables
        variables:
          - name: get_graphql_body
            value: |
              {
                "query": "<? graphql_query ?>"
              }

      - type: api-request
        method: POST
        system_alias: ConcurProfileBotAPI
        path: "/graphql"
        body: "<? get_graphql_body ?>"
        result_variable: get_result
        timeout: 30

  # Process name retrieval response
  - condition: get_result != null && get_result.status_code == 200
    actions:
      - type: set-variables
        variables:
          - name: get_response_body
            value: "<? get_result.body ?>"
          - name: profile_data
            value: "<? get_response_body.data.JouleCompleteUserProfile ?>"
          - name: name_data
            value: "<? profile_data != null ? profile_data.name : null ?>"
          - name: current_first_name
            value: "<? name_data != null ? name_data.firstName : '' ?>"
          - name: current_last_name
            value: "<? name_data != null ? name_data.lastName : '' ?>"
          - name: current_middle_name
            value: "<? name_data != null ? name_data.middleName : '' ?>"
          - name: current_preferred_name
            value: "<? name_data != null ? name_data.preferredName : '' ?>"
          - name: current_honorific_prefix
            value: "<? name_data != null ? name_data.honorificPrefix : '' ?>"
          - name: current_honorific_suffix
            value: "<? name_data != null ? name_data.honorificSuffix : '' ?>"
          - name: has_names
            value: "<? current_first_name != null && !current_first_name.isEmpty() ?>"

  # Case 1: No action specified - show current names and options
  - condition: action_type == null && !has_update_fields
    actions:
      - type: set-variables
        variables:
          - name: operation_status
            value: "show_options"

      - type: message
        scripting_type: handlebars
        message:
          type: text
          content: |
            üë§ Your Profile Names
            
            {{#if has_names}}
            ‚Ä¢ üë§ First Name: {{#if current_first_name}}{{current_first_name}}{{else}}(not set){{/if}}
            ‚Ä¢ üë§ Last Name: {{#if current_last_name}}{{current_last_name}}{{else}}(not set){{/if}}
            ‚Ä¢ üë§ Middle Name: {{#if current_middle_name}}{{current_middle_name}}{{else}}(not set){{/if}}
            ‚Ä¢ ‚≠ê Preferred Name: {{#if current_preferred_name}}{{current_preferred_name}}{{else}}(not set){{/if}}
            ‚Ä¢ üé© Honorific Prefix: {{#if current_honorific_prefix}}{{current_honorific_prefix}}{{else}}(not set){{/if}}
            ‚Ä¢ üéì Honorific Suffix: {{#if current_honorific_suffix}}{{current_honorific_suffix}}{{else}}(not set){{/if}}
            {{else}}
            üìã No profile names found.
            {{/if}}
            
            üîß What would you like to do?
            ‚Ä¢ ‚úèÔ∏è Update your name information
            ‚Ä¢ üëÅÔ∏è View current names (this display)
            
            üí° Examples:
            "Set my first name to John"
            "Update my last name to Smith"
            "Change my preferred name to Johnny"
            "Set first name John and last name Smith"

  # Case 2: GET action - show current names
  - condition: action_type == 'get'
    actions:
      - type: set-variables
        variables:
          - name: operation_status
            value: "get_names"

      - type: message
        scripting_type: handlebars
        message:
          type: text
          content: |
            üë§ Your Current Profile Names
            
            {{#if has_names}}
            ‚Ä¢ üë§ First Name: {{#if current_first_name}}{{current_first_name}}{{else}}(not set){{/if}}
            ‚Ä¢ üë§ Last Name: {{#if current_last_name}}{{current_last_name}}{{else}}(not set){{/if}}
            ‚Ä¢ üë§ Middle Name: {{#if current_middle_name}}{{current_middle_name}}{{else}}(not set){{/if}}
            ‚Ä¢ ‚≠ê Preferred Name: {{#if current_preferred_name}}{{current_preferred_name}}{{else}}(not set){{/if}}
            ‚Ä¢ üé© Honorific Prefix: {{#if current_honorific_prefix}}{{current_honorific_prefix}}{{else}}(not set){{/if}}
            ‚Ä¢ üéì Honorific Suffix: {{#if current_honorific_suffix}}{{current_honorific_suffix}}{{else}}(not set){{/if}}
            {{else}}
            üìã No profile names found in your profile.
            {{/if}}

  # Case 3: SET/UPDATE action with no fields provided - ask for input
  - condition: is_update_action && !has_update_fields
    actions:
      - type: set-variables
        variables:
          - name: operation_status
            value: "update_missing_fields"
          - name: update_status
            value: 999  # Set to non-zero to prevent error handling

      - type: message
        scripting_type: handlebars
        message:
          type: text
          content: |
            ‚ùì What would you like to update?
            
            {{#if has_names}}
            Your current profile names:
            ‚Ä¢ üë§ First Name: {{#if current_first_name}}{{current_first_name}}{{else}}(not set){{/if}}
            ‚Ä¢ üë§ Last Name: {{#if current_last_name}}{{current_last_name}}{{else}}(not set){{/if}}
            ‚Ä¢ ‚≠ê Preferred Name: {{#if current_preferred_name}}{{current_preferred_name}}{{else}}(not set){{/if}}
            
            {{/if}}
            Please specify which name(s) you'd like to update:
            ‚Ä¢ üë§ First Name
            ‚Ä¢ üë§ Last Name  
            ‚Ä¢ ‚≠ê Preferred Name
            
            üí° Examples:
            "Set my first name to John"
            "Update my last name to Smith"
            "Change my preferred name to Johnny"
            "Set first name John and last name Smith"

  # Case 4: SET/UPDATE action with fields provided OR direct field update (no action specified but has fields)
  - condition: (is_update_action && has_update_fields) || (action_type == null && has_update_fields)
    actions:
      - type: set-variables
        scripting_type: handlebars
        variables:
          - name: update_fields_list
            value: |
              {{#if first_name}}‚Ä¢ First Name: {{first_name}}
              {{/if}}{{#if last_name}}‚Ä¢ Last Name: {{last_name}}
              {{/if}}{{#if preferred_name}}‚Ä¢ Preferred Name: {{preferred_name}}
              {{/if}}

      - type: message
        scripting_type: handlebars
        message:
          type: text
          content: |
            ‚úèÔ∏è Updating Profile Names
            
            {{update_fields_list}}

      - type: set-variables
        scripting_type: handlebars
        variables:
          - name: update_body
            value: |
              {
                "query": "mutation UpdateCompleteUserProfile($input: CompleteUserProfileInput!) { updateCompleteUserProfile(input: $input) { id userName name { firstName lastName preferredName } } }",
                "variables": {
                  "input": {
                    "general": {
                      {{#if first_name}}"firstName": "{{first_name}}"{{/if}}{{#if last_name}}{{#if first_name}},{{/if}}"lastName": "{{last_name}}"{{/if}}{{#if preferred_name}}{{#if (or first_name last_name)}},{{/if}}"preferredName": "{{preferred_name}}"{{/if}}
                    }
                  }
                }
              }

      - type: api-request
        method: POST
        system_alias: ConcurProfileBotAPI
        path: "/graphql"
        body: "<? update_body ?>"
        result_variable: update_result
        timeout: 30

      - type: set-variables
        variables:
          - name: update_status
            value: "<? update_result != null ? update_result.status_code : 0 ?>"

  # Handle update result - success
  - condition: (is_update_action || (action_type == null && has_update_fields)) && update_status == 200
    actions:
      - type: set-variables
        variables:
          - name: operation_status
            value: "update_success"
      
      - type: message
        scripting_type: handlebars
        message:
          type: text
          content: |
            ‚úÖ Profile Names Updated Successfully
            
            üìù Updated fields:
            {{#if first_name}}‚Ä¢ First Name: {{first_name}}
            {{/if}}{{#if last_name}}‚Ä¢ Last Name: {{last_name}}
            {{/if}}{{#if preferred_name}}‚Ä¢ Preferred Name: {{preferred_name}}
            {{/if}}
            
            ‚ö†Ô∏è Note: Changes may take a few seconds to appear due to API processing.

  # Handle update result - failure (only for actual API attempts)
  - condition: (is_update_action || (action_type == null && has_update_fields)) && has_update_fields && update_status != 200 && update_status != 0
    actions:
      - type: set-variables
        variables:
          - name: operation_status
            value: "update_failed"
          - name: error_msg
            value: "<? 'HTTP ' + update_status ?>"
      
      - type: message
        message:
          type: text
          content: "‚ùå Failed to Update Profile Names\n\nüö® Error: <? error_msg ?>"

  # Handle update result - connection failure (only for actual API attempts)
  - condition: (is_update_action || (action_type == null && has_update_fields)) && has_update_fields && update_status == 0
    actions:
      - type: set-variables
        variables:
          - name: operation_status
            value: "update_failed"
      
      - type: message
        message:
          type: text
          content: "‚ùå Failed to Update Profile Names\n\nüö® Error: Connection failed"

  # Handle API errors for get operation
  - condition: get_result != null && get_result.status_code != 200
    actions:
      - type: set-variables
        variables:
          - name: operation_status
            value: "retrieval_error"
          - name: result_message
            value: "<? 'API Error: ' + get_result.status_code ?>"

      - type: message
        message:
          type: text
          content: "‚ùå Failed to Retrieve Profile Names\n\nüö® Error: <? result_message ?>"

  # Handle connection failure for get operation
  - condition: get_result == null
    actions:
      - type: set-variables
        variables:
          - name: operation_status
            value: "retrieval_error"
          - name: result_message
            value: "No response from profile service"

      - type: message
        message:
          type: text
          content: "‚ùå Failed to Retrieve Profile Names\n\nüö® Error: Connection failed"
